<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.store">

    <select id="selectStoreList" parameterType="com.dchans.api.admin.dto.store.StoreDto$StoreRequestDto" resultType="com.dchans.api.admin.dto.store.StoreDto$StoreResponseDto">
        select store_code, store_name, category_type, status, ceo_name, phone, email, concat(address, '' , address_detail) as address,
            group_concat(
                case c.category_code
                when '0' then 'ì‹ ì '
                when '1' then 'ì² í•™ê´€'
                when '2' then 'íƒ€ë¡œ'
                when '3' then 'êµ¿ë‹¹'
                when '4' then 'ê¸°ë„í„°'
                else 'ì‚¬ì°°'
                end
                order by c.category_code
                separator ', '
            ) as categoryName,
            case status
            when 0 then 'í™œì„±'
            when 1 then 'ë¹„í™œì„±'
            end as statusName,
            to_char(created_at,'YYYY-MM-DD') as createdAt
        from store s
        cross join (
            select '0' as category_code union all
            select '1' union all select '2' union all
            select '3' union all select '4' union all select '5'
        ) c
        where 1=1
        and find_in_set(c.category_code, s.category_type) > 0
        <if test="name != null and name != ''">
            and store_name like concat('%', #{name}, '%')
        </if>
        <if test="address != null and address != ''">
            and address like concat('%', #{address}, '%')
        </if>
        <if test="startDate != null and startDate != ''">
            and to_char(created_at,'YYYY-MM-DD') >= #{startDate}
        </if>
        <if test="endDate != null and endDate != ''">
            and to_char(created_at,'YYYY-MM-DD') <![CDATA[<=]]> #{endDate}
        </if>
        <if test="categoryType != null and categoryType.size() > 0">
            and (
            <foreach collection="categoryType" item="category" separator=" OR ">
                FIND_IN_SET(#{category}, s.category_type) > 0
            </foreach>
            )
        </if>
        group by s.store_code, s.store_name, s.category_type, s.status, s.ceo_name, s.phone, s.address, s.created_at
        order by created_at desc
        limit #{pageSize} offset #{offset}
    </select>

    <select id="selectStoreCount" parameterType="com.dchans.api.admin.dto.store.StoreDto$StoreRequestDto" resultType="int">
        select count(*) from store
        where 1 = 1
        <if test="name != null and name != ''">
            and store_name like concat('%', #{name}, '%')
        </if>
        <if test="address != null and address != ''">
            and address like concat('%', #{address}, '%')
        </if>
        <if test="startDate != null and startDate != ''">
            and to_char(created_at,'YYYY-MM-DD') >= #{startDate}
        </if>
        <if test="endDate != null and endDate != ''">
            and to_char(created_at,'YYYY-MM-DD') <![CDATA[<=]]> #{endDate}
        </if>
        <if test="categoryType != null and categoryType.size() > 0">
            and (
            <foreach collection="categoryType" item="category" separator=" OR ">
                FIND_IN_SET(#{category}, category_type) > 0
            </foreach>
            )
        </if>
    </select>

<!--    <resultMap id="StoreDetailResultMap" type="com.dchans.api.admin.dto.store.StoreDto$StoreResponseDto">-->
<!--        &lt;!&ndash; ID ë§¤í•‘ (ì¤‘ìš”!) - ê°™ì€ store_codeë¼ë¦¬ ê·¸ë£¹í•‘ &ndash;&gt;-->
<!--        <id property="storeCode" column="store_code"/>-->
<!--        <result property="storeName" column="store_name"/>-->
<!--        <result property="categoryType" column="category_type"/>-->
<!--        <result property="status" column="status"/>-->
<!--        <result property="ceoName" column="ceo_name"/>-->
<!--        <result property="businessNumber" column="business_number"/>-->
<!--        <result property="zipCode" column="zip_code"/>-->
<!--        <result property="phone" column="phone"/>-->
<!--        <result property="email" column="email"/>-->
<!--        <result property="address" column="address"/>-->
<!--        <result property="addressDetail" column="address_detail"/>-->
<!--        <result property="description" column="description"/>-->
<!--        <result property="memo" column="memo"/>-->
<!--        <result property="startTime" column="start_time"/>-->
<!--        <result property="endTime" column="end_time"/>-->
<!--        <result property="createdAt" column="createdAt"/>-->

        <!-- ðŸŽ¯ í•µì‹¬: Collection ë§¤í•‘ -->
        <!-- MyBatisê°€ ê°™ì€ store_codeì˜ ì—¬ëŸ¬ í–‰ì„ í•˜ë‚˜ë¡œ í•©ì³ì„œ products ë°°ì—´ë¡œ ë§Œë“¦ -->
<!--        <collection property="products" javaType="java.util.ArrayList"  ofType="com.dchans.api.admin.dto.store.StoreProductDto">-->
<!--            <id property="productCode" column="product_code"/>-->
<!--            <result property="storeCode" column="store_code"/>-->
<!--            <result property="name" column="product_name"/>-->
<!--            <result property="price" column="product_price"/>-->
<!--        </collection>-->
<!--    </resultMap>-->


    <select id="selectStoreDetail" parameterType="com.dchans.api.admin.dto.store.StoreDto$StoreRequestDto" resultType="com.dchans.api.admin.dto.store.StoreDto$StoreResponseDto">
        SELECT
            s.store_code,
            s.store_name,
            s.category_type,
            s.status,
            s.ceo_name,
            s.business_number,
            s.zip_code,
            s.phone,
            s.email,
            s.address,
            s.address_detail,
            s.description,
            s.memo,
            s.start_time,
            s.end_time
        FROM store s
        WHERE s.store_code = #{storeCode}
    </select>

    <select id="selectStoreProductList" parameterType="com.dchans.api.admin.dto.store.StoreDto$StoreRequestDto" resultType="com.dchans.api.admin.dto.store.StoreDto$StoreProductDto">
        SELECT
            s.product_name as name,
            s.product_price as price
        FROM store_product s
        WHERE s.store_code = #{storeCode}
    </select>


    <insert id="upsertStore" parameterType="com.dchans.api.admin.dto.store.StoreDto$StoreCreateDto" >
        insert into store (
        store_name,
        store_code,
        category_type,
        ceo_name,
        phone,
        email,
        zip_code,
        address,
        address_detail,
        description,
        memo,
        start_time,
        end_time,
        status
        )values(
        #{storeName},
        <choose>
            <when test="storeCode != null and storeCode != ''">
                #{storeCode}
            </when>
            <otherwise>
                concat('ST_',date_format(current_timestamp, '%Y%m%d'),lpad((select coalesce(max(seq), 0) + 1 from store), 4, '0'))
            </otherwise>
        </choose>,
        #{categoryType},
        #{ceoName},
        #{phone},
        #{email},
        #{zipCode},
        #{address},
        #{addressDetail},
        #{description},
        #{memo},
        #{startTime},
        #{endTime},
        #{status}
        )
        on duplicate key update
        store_name = #{storeName},
        category_type = #{categoryType},
        ceo_name = #{ceoName},
        phone = #{phone},
        email = #{email},
        zip_code = #{zipCode},
        address = #{address},
        address_detail = #{addressDetail},
        description = #{description},
        memo = #{memo},
        start_time = #{startTime},
        end_time = #{endTime},
        status = #{status}
    </insert>

    <delete id="deleteStoreProduct">
        delete from store_product
        where 1 = 1
        and store_code = #{storeCode}
    </delete>

    <insert id="insertStoreProduct" parameterType="com.dchans.api.admin.dto.store.StoreDto$StoreProductDto">
        insert into store_product (store_code, product_code, product_name, product_price)
        values
        <foreach collection="list" item="item" index="idx" separator=",">
            (
            #{item.storeCode},
            concat('ST_PRO',date_format(current_timestamp, '%Y%m%d'),lpad((select coalesce(max(seq), 0) + 1 from store_product), 4, '0')),
            #{item.name},
            #{item.price}
            )
        </foreach>
    </insert>


    <delete id="deleteStore">
        delete from store
        where 1 = 1
        and store_code in
        <foreach collection="storeCodeList" item="storeCode" open="(" close=")" separator=",">
            #{storeCode}
        </foreach>
    </delete>
</mapper>