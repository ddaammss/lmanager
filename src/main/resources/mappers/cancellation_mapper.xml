<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cancellation">

    <select id="selectCancellationList" parameterType="com.dchans.api.admin.dto.reservation.ReservationDto$ReservationRequestDto" resultType="com.dchans.api.admin.dto.reservation.ReservationDto$ReservationResponseDto">
        select id, reservation_no, reserver_name, reserver_phone, store_no, reservation_start_date, reservation_end_date, confirm_start_date, confirm_end_date, guest_count, payment_amount, category_type, result_type, reservation_type, to_char(created_at,'YYYY-MM-DD') as createdAt from reservation
        where 1 = 1
        <if test="name != null and name != ''">
            <if test='type1 == "0"'>
                and reserver_name = #{name}
            </if>
            <if test='type1 == "1"'>
                and store_no = #{name}
            </if>
        </if>

        <if test='type2 != null and type2.equals("0")'>
            and confirm_start_date >= #{confirmStartDate} and confirm_end_date <![CDATA[<=]]> #{confirmEndDate}
        </if>
        <if test='type2 != null and type2.equals("1")'>
            and reservation_start_date >= #{reservationStartDate} and reservation_end_date <![CDATA[<=]]> #{reservationEndDate}
        </if>
        <if test="categoryType != null and categoryType != ''">
            and category_type = #{categoryType}
        </if>
        <if test="resultType != null and resultType != ''">
            and result_type = #{resultType}
        </if>
        <if test="reservationType != null and reservationType != ''">
            and reservation_type = #{reservationType}
        </if>
        and reservation_type in ('2')
        order by created_at desc
        limit #{pageSize} offset #{offset}
    </select>

    <select id="selectCancellationCount" parameterType="com.dchans.api.admin.dto.reservation.ReservationDto$ReservationRequestDto" resultType="int">
        select count(*) from reservation
        where 1 = 1
        <if test="name != null and name != ''">
            <if test='type1 == "0"'>
                and reserver_name = #{name}
            </if>
            <if test='type1 == "1"'>
                and store_no = #{name}
            </if>
        </if>
        <if test='type2 != null and type2.equals("0")'>
            and confirm_start_date >= #{confirmStartDate} and confirm_end_date <![CDATA[<=]]> #{confirmEndDate}
        </if>
        <if test='type2 != null and type2.equals("1")'>
            and reservation_start_date >= #{reservationStartDate} and reservation_end_date <![CDATA[<=]]> #{reservationEndDate}
        </if>
        <if test="categoryType != null and categoryType != ''">
            and category_type = #{categoryType}
        </if>
        <if test="resultType != null and resultType != ''">
            and result_type = #{resultType}
        </if>
        <if test="reservationType != null and reservationType != ''">
            and reservation_type = #{reservationType}
        </if>
        and reservation_type in ('2')
    </select>


    <select id="selectCancellationDetail" parameterType="com.dchans.api.admin.dto.reservation.ReservationDto$ReservationRequestDto" resultType="com.dchans.api.admin.dto.reservation.ReservationDto$ReservationResponseDto">
        select id, reservation_no, reserver_name, reserver_phone, store_no, reservation_start_date, reservation_end_date, confirm_start_date, confirm_end_date, guest_count, payment_amount, category_type, result_type, reservation_type, to_char(created_at,'YYYY-MM-DD') as createdAt from reservation
        where reservation_no = #{reservationNo}
    </select>

    <update id="updateCancellation" parameterType="com.dchans.api.admin.dto.reservation.ReservationDto$ReservationUpdateDto">
        update reservation set result_type = #{resultType}, reservation_type = #{reservationType}
        where reservation_no = #{reservationNo}
    </update>
</mapper>